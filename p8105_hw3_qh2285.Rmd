---
title: "p8105_hw3_qh2285"
author: "Qianxuan Huang"
date: "2024-10-13"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(ggridges)
library(haven)
```

# problem 1

# problem 2

Load and tidy data; exclude participants less than 21 years of age and those with missing demographic data; encode data with reasonable variable classes:
```{r}
participants_df = #data start at row 4
    read_csv("./data/nhanes_covar.csv", na = c("NA", "", "."), skip = 4) |>
  janitor::clean_names() |> 
  mutate(sex = recode(sex, "1" = "male", "2" = "female"),
         education = recode(education, "1" = "Less than high school", 
                            "2" = "High school equivalent", 
                            "3" = "More than high school")) |>
  filter(age >= 21) |>
  drop_na()

accelerometer_df = 
  read_csv("./data/nhanes_accel.csv", na = c("NA", "", ".")) |>
  janitor::clean_names()
```
merge datasets:
```{r}
final_df = participants_df |>
  left_join(accelerometer_df, by = "seqn")
```
reader-friendly table:
number of men and women in each education category:
```{r}
final_df |>
  mutate(education = forcats::fct_relevel(education, c("Less than high school", "High school equivalent", "More than high school"))) |>
  janitor::tabyl(education, sex)
```
create a visualization of the age distributions for men and women in each education category:
```{r}
final_df |>
  mutate(education = forcats::fct_relevel(education, c("Less than high school", "High school equivalent", "More than high school"))) |>#change order
  ggplot(aes(x = age, color = sex)) +
  geom_histogram() +
  labs(title = "Age Distribution by Sex and Education Level",
       x = "Age", y = "Count") +
  theme_minimal() +
  facet_grid(. ~ education) #seperate graphs
```
For female, 28, 23, 59 people in Less than high school, High school equivalent, More than high school; for male they are 27, 35,56.
For people in Less than high school group, distribution and number of female and male are very similar. For people in High school equivalent group, numb of male is bigger than female; and distribution is concentrated at ages very old or young in both sex. For people in More than high school group, number of female and male are very similar, both sex shown left-skewed distribution.





Traditional analyses of accelerometer data focus on the total activity over the day. Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant:
```{r}
activity_df = final_df |>
  mutate(education = forcats::fct_relevel(education, c("Less than high school", "High school equivalent", "More than high school"))) |>
  rowwise() |>
  mutate(total_activity = sum(c_across(starts_with("min")))) |>
  select(!(starts_with("min")))
```

Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences:
```{r}
ggplot(activity_df, aes(x = age, y = total_activity, color = sex)) +  
  geom_point() + 
  geom_smooth(se = FALSE) +
  facet_wrap(. ~ education) +  
  labs(title = "Total Activity against Age by Education Level and Gender",
       x = "Age", y = "Total activity")
```
The total activity points don't fit the curve at all because they are too scattered. No trend can be concluded of total activity against age by education level.






Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex:
```{r}
activity_summary = final_df |>
  mutate(education = forcats::fct_relevel(education, c("Less than high school", "High school equivalent", "More than high school"))) |>
  group_by(sex, education) |>
  summarise(across(starts_with("min"), mean, na.rm = TRUE))

# Pivot the dataset to calculate mean of each min
activity_summary_long <- activity_summary |>
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               names_prefix = "min", 
               values_to = "avg_activity") |>
  mutate(minute = as.numeric(minute))

ggplot(activity_summary_long, aes(x = minute, y = avg_activity, color = sex)) +
  geom_line() +  
  geom_smooth(se = FALSE) +  
  facet_wrap(. ~ education, ncol = 1) + 
  labs(title = "24-hour Average Activity Time Course by Education Level and Sex", x = "Minute", y = "Mean Activity") 
```

Three education level shows same trends throughout the day that low activity at night and increase in the morning. For High school equivalent and More than high school group, female shows higher activity level than male in general, but not in Less than high school group.


# problem 3